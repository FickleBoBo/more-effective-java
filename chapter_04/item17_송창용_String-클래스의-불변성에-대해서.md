## 불변객체와 관련한 String 클래스 탐구.

### 정리

**내용 요약**

저자는 인스턴스의 변경 가능성을 최소화 하기 위한 방법으로 `불변 클래스`에 대해 소개한다.

`불변 클래스`를 간단하게 설명하면 인스턴스 내부 값을 수정할 수 없는 클래스를 말한다.

`불변 클래스`로 대표적인 것들로는 String, BigInteger, BigDecimal 등이 있다.

이러한 `불변 클래스`를 만들기 위한 __다섯 가지 규칙__ 이 존재한다.

1. 객체의 상태를 변경하는 메서드를 제공하지 않는다.
    + ex) setter와 같은 메서드가 여기에 해당된다.

2. final로 클래스를 선언하여 해당 클래스를 __상속받지 못하도록__ 한다.

3. 모든 필드를 final로 선언한다.
    + 이는 설계자의 의도가 명확하게 보이도록 만들어준다.

4. 모든 필드를 private으로 선언한다.
    + 다른 객체를 참조하는 필드를 __public final__ 로만 선언하여도 불변 객체가 되지만, 다음 릴리스에서 내부 표현에 대한 변경이 불가능하므로 권하지 않는다.

5. 자신 외에는 내부의 가변 컴포넌트에 접근하지 못하도록 한다.
    + 클래스 내부에 가변 객체를 참조하는 필드가 있다면, 클라이언트가 직접 해당 가변 객체를 참조할 수 없어야 한다. 또한 접근자 메서드가 해당 필드를 `그대로 반환해서도 안된다`.
        + 따라서 접근자 메서드를 통해 해당 필드를 반환할 때는, __방어적 복사__ 를 수행하여야 한다.

---

`불변 클래스`를 나타내는 것에는 복소수를 나타내는 Complex 클래스도 존재한다.

+ 해당 Complex 클래스 내부에 존재하는 메서드들은, Complex 인스턴스 내부의 값을 변환시키지 않고, 새로운 Complex 인스턴스를 만들어서 반환하여 __불변 객체의 특성을 유지__ 한다.

    + 이러한 피연산자에 대하여 함수를 적용해 그 결과를 반환하지만 피연산자 자체는 변화시키지 않는 방식을 함수형 프로그래밍이라 한다.
    + 반대로 피연산자가 변화하는 방식을 절차혁, 명령형 프로그래밍이라 한다.
        + 자기 자신을 수정하지 않는 함수형 프로그래밍은 메서드로 동사(EX. add)를 사용하는 대신 전치사(EX. plus)를 사용한다.
        + BigInteger와 BigDecimal은 이 명명 규칙(동사 대신 전치사)을 사용하지 않아서 많은 사람들로 하여금 오류를 일으키게 만들었다.

---

`불변 클래스`는 clone 메서드나 복사 생성자를 제공하지 않는 게 좋다. String 복사 생성자는 자바 초창기 때 만들어진 설계 실수이다.

`불변 클래스`의 장점으로 불변 객체를 자연스럽게 공유할 수 있고, 불변 객체끼리 내부 데이터를 공유할 수 있으며, 불변식을 유지하기 수월하도록 만들어주며, 실패 원자성을 제공하는 것 등이 있다.

그러나 `불변 클래스`에도 단점은 존재한다.

`불변 클래스`의 단점은 성능과 관련된 것으로,

___값이 다르면 독립된 객체로 만들어야 한다__ 는 것이 불변 객체를 완성하는 단계를 많게 하고, 그 중간 단계에 사용되고 버려지는 객체가 많아서 성능 문제가 커질 수 있다.

이러한 성능 문제에 대한 해결책 또한 존재하는데, 그것은 바로 다단계 연산이다. 이 다단계 연산을 사용하면 각 단계마다 객체를 생성하지 않아도 되기 때문에 연산속도가 빨라진다.

---

`불변 클래스`를 만들기 위해서는 불변 클래스에 대한 `규칙 2`에서 말한 것처럼 `불변 클래스`를 다른 곳에서 상속하지 못하도록 해야한다.

이 방법은 두 가지가 존재한다.

1. final 클래스로 선언하기.

2. 모든 생성자를 private 혹은 package-private으로 만들고, public 정적 팩터리를 제공하는 방법이다.

    + 이전 내용 중에서 정적 팩터리에 대해서 다룰 때, 상속을 받지 못하는 것이 단점이 될 수도, 장점이 될 수도 있다고 나왔었다.

    + 하지만 이 상황처럼 __정적 팩터리 메서드__ 클래스가 상속을 받지 못하기 때문에, 불변 객체의 조건을 충족시키기 위한 요소가 될 수 있다.

---

`불변 클래스`의 규칙 중 '모든 필드는 final이고 어떤 메서드도 그 객체를 수정할 수 없어야 한다.' 라는 규칙은 과할 수 있기 때문에, 다음과 같이 완화할 수 있다.

___어떤 메서드도 객체의 상태 중 외부에 비치는 값을 변경할 수 없다.___

이렇게 규칙을 완화하면, 계산 비용이 큰 값을 필드에 캐시해놓고 요청되었을 경우, 캐시해둔 값을 바로 반환하여 계산 비용을 절감할 수 있다.



### 심화 탐구

**출발점**


불변 객체에 대해 배우면서, 이전에 가졌던 궁금증이 다시금 떠올랐다.

String 객체는 왜 불변 객체인 것일까?

이전, String 클래스의 equals와 Object 클래스의 equals 메서드를 비교하고자 한 적이 있다.

이를 위해 String 클래스를 상속받아서 equals 메서드를 오버라이딩 하는 방식으로 Object 클래스가 갖고 있는 equals 메서드와 같은 기능을 구현하고자 하였는데,

String 객체는 final로 선언되어 있어 다른 클래스에서 상속받는 것이 불가능하였다.

본문 Item 17에서 알게된 불변 객체의 특성과 연관지어서 String 은 왜 불변 객체인지 탐구해보겠다.


**설명**

Java의 창시자 James Gosling이 인터뷰에서 질문을 들었다. 

'String은 어째서 불변 객체로 설계되었나요?'

이에 James Gosling은 이렇게 대답했다.

`저는 할 수 있다면 전부 불변 객체로 설계합니다.(I would use an immutable whenever I can)`

Java 언어의 창시자가 이렇게 말할 정도로 불변성은 중요시되는 요소인데, String 클래스가 불변 클래스로 설정된 것에는 구체적으로 네 가지 이유가 존재한다.

1. Memory

    + String이 불변 클래스로 설계되었기 때문에, JVM은 일정량의 메모리 공간을 String pool에 할당하고, 각각의 String 값들은 String pool을 참조할 수 있다.

        + String 이 불변 클래스이기 때문에 String 값들이 의도와는 다른 곳을 가리키게 되지 않고 지속적이고 안정적으로 String pool 내부의 동일한 String 값을 참조하게 된다.

    + 이러한 String pool 덕분에 프로그램을 설계하면서 많은 메모리를 절약할 수 있다.


2. Security

    + 만일 String 클래스가 불변 클래스가 아니라면, 프로그래머는 String 객체를 받아올 때마다 해당 객체를 신뢰할 수 없을 것이다.
    + 비록 검증 하는 부분을 구현한다고 해도 그로 인한 성능저하가 따라올 것이며, 완전한 검증이 불가능하다.
    + 심지어 검증 부분을 추가하게 되면서 해당 String 값이 외부에 노출될 위험이 증가하게 된다.

    + String 클래스가 불변 클래스라면 신뢰성을 담보할 수 있고, 그로 인해 프로그래머는 검증 부분을 구현하지 않아도 되어 효율적인 작업이 가능하게 된다.

3. Synchronization

    + `동기화`란 하나의 데이터에 대해 두 가지 작업이 이루어질 때, 하나의 작업이 이루어지는 동안 다른 작업이 간섭하여 다른 데이터로 변경하여 의도와는 다른 결과물이 나오게 되는 것이다.

    + String 클래스가 불변 클래스이기 때문에, String 값에 대한 여러 작업이 이루어져도, String 데이터가 변경되는 것이 아닌 작업이 이루어져 변화된 데이터가 String pool에 새롭게 추가되는 것이다.

    + 따라서, String 클래스는 한 번에 여러 작업이 이루어지는 multi-threading 방식에 있어서 안전하다고 할 수 있다.

4. Performance

    + 불변 클래스인 String 클래스는 HashMap, HashTable, HashSet과 같이 Hash 값을 사용하는 자료구조에서의 성능을 향상시킨다.

    + String 값의 불변성이 보장되기 때문에, 한 번의 Hash 값 계산 이후 또 다시 Hash 값을 계산하지 않고 동일한 Hash 값을 반환하기만 하면 되기 때문이다.


처음 String 클래스의 불변성을 알게 되었을 때, 내부 equals 메서드가 변경되지 않도록 불변 클래스로 설계한 것이라 생각하였다.

그러나, equals 메서드의 변경을 방지하면서도 불변성이라는 특성 자체에서 얻을 수 있는 여러 장점이 있기 때문에 String 클래스는 불변 클래스라는 것을 알게 되었다.




Reference:
https://www.baeldung.com/java-string-immutable